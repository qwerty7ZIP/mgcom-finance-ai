# План проекта MGCOM Finance AI

## 1. Цели и MVP

- **Цель**: внутренний веб‑сервис, который по запросу руководителей формирует таблицы и выборки на основе корпоративных данных (клиенты, контакты, тендеры), с возможностью донастройки через фильтры и дополнительное общение с ИИ.
- **ИИ**: YandexGPT (через официальный API), русский язык запросов и ответов.
- **Данные**: структурированные таблицы в **БД Supabase (PostgreSQL)**. Источником этих таблиц могут быть Excel‑файлы/выгрузки, но в рантайме приложение работает только с базой данных (clients, contacts, tenders).
- **Пользовательский опыт**:
  - Пользователь в чате описывает, какие данные хочет увидеть.
  - ИИ выдаёт таблицу (колонки + строки) + пояснение при необходимости.
  - Пользователь может менять выборку как через UI‑фильтры и сортировку, так и через новые сообщения в чате.
  - Таблица поддерживает фильтрацию по каждому столбцу, сортировку, пагинацию, выбор видимых колонок и экспорт в Excel/CSV.
- **Аутентификация**: вход только по учёткам, которые создаёт админ (без саморегистрации), пока без ролей.
- **Дизайн**: строгий корпоративный BI‑дашборд с переключателем светлая/тёмная тема.

## 2. Архитектура и стек (актуальная)

## 2. Архитектура и стек (актуальная)

- **Общая схема**
  - Один full‑stack проект на базе современного React‑фреймворка (**Next.js + React + TypeScript**).
  - Бэкенд (серверные роуты Next.js) для:
    - работы с БД Supabase (PostgreSQL) — чтение таблиц `clients`, `contacts`, `tenders`;
    - подготовки данных для таблицы (фильтрация, пагинация, экспорт — частично на фронте, частично позже можно перенести в БД);
    - общения с YandexGPT и трансляции запросов пользователя в структуру запроса к данным (`TableRequest`).
  - Фронтенд для:
    - интерфейса чата с ИИ;
    - отображения и интерактивной работы с таблицей;
    - (позже) админки для настройки справочников и связей.

- **Технологический стек**
  - **Фронтенд**: React + TypeScript, компонентная библиотека/utility‑CSS (Tailwind + при необходимости shadcn/ui) под строгий корпоративный стиль.
  - **Фреймворк**: Next.js (App Router) с серверными роутами (`/api/...`).
  - **Бэкенд**: серверные роуты Next.js (Node.js) для API.
  - **Хранение данных**:
    - сразу **PostgreSQL в Supabase** как основное хранилище;
    - при необходимости — офлайн‑импорт из Excel/выгрузок во внутренние таблицы Supabase (без прямого чтения файлов в рантайме).
  - **ИИ‑слой**: YandexGPT API, промпты и формат структурированного ответа (JSON‑схема таблицы + фильтры/условия) — `TableRequest`.
  - **Аутентификация**: простая модель пользователей (email/логин + пароль), CRUD через админку.

## 3. Данные и связи

- **Источник данных (рантайм)**
  - База данных Supabase (PostgreSQL) с тремя основными логическими таблицами:
    - `clients` — клиенты;
    - `contacts` — контактные лица;
    - `tenders` — тендеры.
  - Таблицы могут наполняться:
    - вручную (SQL/админка Supabase);
    - через отдельный импорт из Excel/выгрузок (скрипт или админ‑функция, но **не** в рамках основного рантайма Next.js).

- **Связи (MVP)**
  - Поддержка связей по полю «клиент» между:
    - таблицей `clients`;
    - таблицей `contacts` (поле `company` или эквивалент);
    - таблицей `tenders` (поле `client`).
  - Модель связей логически описана в документации (см. `DATA_MODEL.md`) и используется:
    - для интерпретации запросов ИИ (на какие таблицы и связи опираться),
    - для составления реальных запросов к данным (join/merge) в контексте Supabase/SQL.

- **Обновление данных**
  - Данные обновляются через операции с БД Supabase:
    - прямое редактирование/импорт через Supabase;
    - отдельные вспомогательные скрипты импорта (например, из Excel) — вне рантайма Next.js.

## 4. ИИ‑логика и взаимодействие

- **Формат взаимодействия**
  - Пользователь формулирует запрос на русском языке (например: «Покажи всех клиентов с тендерами за 2024 год с суммой больше 1 млн, добавь колонку с ответственным менеджером»).
  - Сервер:
    1. Передаёт в ИИ:
       - описание доступных таблиц (названия, колонки, типы, связи по полю «Клиент»);
       - краткие инструкции по формату ответа (строгий JSON).
    2. Получает от ИИ **структуру запроса в виде JSON**:
       - какие таблицы использовать;
       - по каким полям фильтровать;
       - какие колонки вывести и в каком порядке;
       - как объединять таблицы по «Клиенту»;
       - (опционально) какие агрегаты/сводки посчитать.
    3. Преобразует JSON‑описание в реальный запрос к локальным данным (SQL или эквивалент на уровне кода).
    4. Возвращает на фронтенд:
       - данные таблицы (строки/колонки);
       - метаданные таблицы (типы колонок, доступные операторы фильтрации);
       - служебную информацию (например, текстовое описание запроса для пользователя).

- **Дальнейшая работа с таблицей**
  - **Ручные изменения**: пользователь управляет фильтрами, сортировкой, видимостью колонок и пагинацией, не обращаясь к ИИ (это работает напрямую на фронтенде/через лёгкие API‑запросы).
  - **Изменения через чат**: новые сообщения пользователя (например: «Оставь только клиентов из госсектора и добавь колонку с контактным лицом») повторно проходят тот же цикл:
    - ИИ генерирует обновлённое JSON‑описание запроса,
    - сервер перестраивает выборку,
    - таблица обновляется.

- **Сводки и аналитика**
  - По запросу пользователя ИИ может:
    - формировать агрегирующие выборки (суммы, количество, конверсия и т.п.);
    - давать текстовые выводы/комментарии к таблице.
  - Важно: сами расчёты по данным выполняются на сервере, ИИ отвечает за формирование «рецепта» (что считать и как отфильтровать).

## 5. UI/UX‑концепция (высокий уровень)

- **Общий вид**
  - Строгий корпоративный BI‑дашборд:
    - верхняя панель навигации с логотипом и переключателем светлая/тёмная тема;
    - основная область: **центральная/левая зона — таблица, правая боковая панель — окно чата с ИИ** с акцентом на «красивый» современный дизайн (анимации, аккуратные карточки сообщений, чипы‑подсказки запросов);
    - акцент на читаемости таблиц и понятных фильтрах.
  - Целевая аудитория — руководители отделов и топ‑менеджмент:
    - минимум «шума»;
    - понятные подписи и статусы;
    - быстрый доступ к нужным выборкам.

- **Таблица**
  - Колонки:
    - заголовок, подсказка/описание при наведении;
    - индикатор типа (число, дата, текст) для выбора подходящего типа фильтра.
  - Фильтрация:
    - строка поиска для текстовых полей;
    - диапазон для чисел и дат;
    - выпадающий список (multi‑select) для категориальных полей.
  - Сортировка:
    - клик по заголовку колонки (asc/desc);
    - визуальный индикатор текущего порядка сортировки.
  - Пагинация:
    - стандартные контролы (номер страницы, «вперёд/назад», выбор размера страницы).
  - Управление колонками:
    - выпадающее меню со списком всех колонок и чекбоксами «показать/скрыть».
  - Экспорт:
    - кнопка «Экспорт в Excel/CSV» с учётом текущих фильтров и сортировок.

- **Чат**
  - История диалога с ИИ;
  - Подсказки по тому, как формулировать запросы («Примеры запросов»);
  - Отображение краткого описания последнего запроса к данным (что именно сейчас показано в таблице).

- **Дизайн‑система**
  - На основе скилла `ui-ux-pro-max` будет создана:
    - глобальная дизайн‑система (цвета, типографика, отступы, компоненты);
    - отдельный документ в `documentation` с выбранным стилем для данного проекта (Master +, при необходимости, page‑overrides).

## 6. Админ‑панель

- **Управление пользователями**
  - Список пользователей;
  - создание нового пользователя (логин/email, имя, пароль);
  - блокировка/разблокировка.

- **Управление файлами**
  - Загрузка нового Excel‑файла:
    - выбор файла;
    - задание логического названия таблицы;
    - просмотр и подтверждение структуры (список колонок, типов).
  - Обновление существующего файла (замена версии).

- **Настройка связей**
  - Выбор таблицы‑источника и таблицы‑приёмника;
  - выбор полей для связи (начнём с «Клиент»);
  - визуальная подсказка, какие связи уже настроены.

## 7. Этапы реализации (дорожная карта)

1. **Инициализация проекта**
   - Создать репозиторий проекта (структура фронтенд+бэкенд).
   - Настроить базовые зависимости (React/Next.js, TypeScript, Tailwind, OpenAI SDK, библиотека для Excel, БД).
   - Настроить базовый routing и архитектуру модулей.

2. **Документация и дизайн‑система**
   - Оформить базовый README и техническое описание в `documentation`.
   - Запустить `ui-ux-pro-max` для генерации дизайн‑системы под кейс «корпоративный финансовый BI‑дашборд».
   - Зафиксировать выбранные цвета, шрифты, отступы, компоненты в отдельном документе.

3. **Слой данных**
   - Реализовать чтение Excel‑файлов из фиксированной папки (локально на dev).
   - Спроектировать структуру хранения (БД или кэш) и таблицу метаданных.
   - Импортировать три стартовые таблицы и настроить связи по полю «Клиент».

4. **Базовый фронтенд (таблица)**
   - Реализовать компонент таблицы с:
     - пагинацией;
     - сортировкой;
     - фильтрацией по колонкам;
     - выбором видимых колонок;
     - экспортом в Excel/CSV.
   - Подключить таблицу к API данных (без ИИ, фиксированный набор выборок).

5. **Чат с ИИ и серверная логика**
   - Реализовать UI чата.
   - Спроектировать и реализовать API‑эндпойнт для общения с OpenAI:
     - описание схемы данных и связей в промпте;
     - строгий JSON‑формат ответа (описание запроса к данным).
   - Реализовать трансляцию ответа ИИ в фактический запрос к данным (SQL/фильтры).
   - Связать чат с таблицей (первичный запрос формирует выборку).

6. **Уточнение запросов через чат**
   - Поддержать сценарий, когда новые сообщения в чате модифицируют текущий запрос (фильтры, колонки, объединения).
   - Обеспечить сохранение контекста диалога.

7. **Админ‑панель**
   - Реализовать управление пользователями (создание учёток).
   - Реализовать загрузку/обновление Excel‑файлов и настройку связей.

8. **Полировка, темы и UX‑детали**
   - Реализовать переключатель светлая/тёмная тема.
   - Проверить единообразие стилей, состояний наведения, фокуса и адаптивность.
   - Оптимизировать производительность таблиц для тысяч строк.

9. **Подготовка к развёртыванию**
   - Настроить сборку/запуск на localhost (под Windows).
   - Подготовить инструкции по переносу на сервер (on‑prem или облако).

Этот план можно уточнять и детализировать по мере появления новых требований и таблиц, но он задаёт чёткую траекторию движения от прототипа к рабочему инструменту для руководителей.

