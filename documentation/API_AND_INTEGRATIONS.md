# API и интеграции MGCOM Finance AI

## 1. Обзор API

В MVP реализованы два основных серверных маршрута (Next.js App Router, `/app/api`):

- `POST /api/chat` — взаимодействие с YandexGPT, получение структурированных запросов к данным.
- `GET /api/data` — получение табличных данных (пока из демо‑слоя).

Оба маршрута возвращают JSON и используются только фронтендом приложения (внутренний API).

---

## 2. `/api/chat` — чат с YandexGPT

- **Метод:** `POST`
- **Путь:** `/api/chat`
- **Файл реализации:** `web/src/app/api/chat/route.ts`

### 2.1. Назначение

Принять запрос пользователя (и историю диалога) на русском языке, отправить его в YandexGPT с системным промптом и вернуть:

- текстовый ответ для отображения в чате;
- JSON‑структуру `tableRequest` для обновления таблицы на дашборде.

### 2.2. Тело запроса

```json
{
  "message": "строка с последним сообщением пользователя",
  "history": [
    { "role": "user", "text": "прошлый вопрос" },
    { "role": "ai", "text": "прошлый ответ" }
  ]
}
```

- `message` — опционально, последнее сообщение пользователя;
- `history` — опциональная история диалога; роли: `"user"` или `"ai"`.

Если и `message`, и `history` отсутствуют, маршрут вернёт ошибку `400`.

### 2.3. Формирование запроса к YandexGPT

Маршрут собирает массив сообщений `yaMessages`:

1. `system` — подробный промпт, описывающий:
   - роль модели (внутренний ассистент для финансовой команды);
   - доступные логические таблицы (`clients`, `contacts`, `tenders`);
   - формат ожидаемого JSON‑ответа (`tableRequest`);
   - правила сохранения контекста и работы с фильтрами/колонками.
2. История диалога (`history`), где:
   - сообщения `role: "ai"` маппятся в `assistant`;
   - сообщения `role: "user"` маппятся в `user`.
3. Текущее сообщение пользователя (`message`), если есть.

Запрос к YandexGPT отправляется в `https://llm.api.cloud.yandex.net/foundationModels/v1/completion` с опциями:

- `temperature: 0.2` (более детерминированные ответы);
- `maxTokens: 1000`;
- `stream: false`.

### 2.4. Переменные окружения

- `YANDEX_GPT_API_KEY` — API‑ключ.
- `YANDEX_GPT_FOLDER_ID` — идентификатор папки в Yandex Cloud.
- `YANDEX_GPT_MODEL_URI` — явный URI модели (опционально, иначе формируется на основе `folderId` и `latest`).

Если какая‑то из переменных (`apiKey`, `folderId` или `modelUri`) не задана, маршрут работает в режиме **заглушки**:

```json
{
  "reply": "Заглушка: YandexGPT не настроен. Отображаю тестовые данные.",
  "data": {
    "tableRequest": {
      "table": "clients",
      "description": "Тестовая таблица (режим офлайн)",
      "filters": [],
      "columns": [],
      "sort": null,
      "limit": 100
    }
  }
}
```

### 2.5. Ответ в нормальном режиме

YandexGPT может возвращать текст с JSON внутри, поэтому маршрут:

1. Получает строку `content` из модели.
2. Пытается извлечь JSON:
   - сначала ищет блоки ```json ... ``` или ``` ... ```;
   - если их нет — берёт подстроку от первого `{` до последней `}`.
3. Парсит JSON через `JSON.parse`.

Финальный ответ API:

```json
{
  "reply": "полный текст ответа модели (может включать пояснения и JSON)",
  "data": {
    "message": "короткий комментарий к действию",
    "tableRequest": {
      "table": "clients | contacts | tenders",
      "description": "описание для заголовка таблицы",
      "filters": [
        {
          "field": "имя колонки",
          "operator": "eq | gte | lte | contains | between | in",
          "value": "значение"
        }
      ],
      "columns": ["имя_колонки_1", "..."],
      "sort": {
        "field": "имя колонки",
        "direction": "asc | desc"
      },
      "limit": 200
    }
  }
}
```

На фронтенде `ChatPanel` извлекает:

- `data.data.tableRequest` (если есть) или `data.data` как `TableRequest`;
- отображает `reply` в чате;
- передаёт `tableRequest` вверх в `Dashboard` для применения к таблице.

### 2.6. Обработка ошибок

- Если ответ YandexGPT не `ok`:
  - логируется статус и тело ответа;
  - по возможности извлекается `error.message` из JSON;
  - возвращается `500` с сообщением об ошибке.
- Если JSON от модели не удаётся распарсить:
  - логируется сырой контент и «очищенный» текст;
  - возвращается `502` с описанием проблемы и `raw` содержимым.

---

## 3. `/api/data` — данные для таблицы

- **Метод:** `GET`
- **Путь:** `/api/data`
- **Файл реализации:** `web/src/app/api/data/route.ts`

### 3.1. Назначение

Вернуть табличные данные (колонки и строки) для одной из логических таблиц:

- `clients`
- `contacts`
- `tenders`

В текущем MVP данные берутся из `getDemoTable` (демо‑слой, не реальные Excel).

### 3.2. Параметры запроса

- `table` — имя таблицы (`clients` по умолчанию).

Пример:

```bash
GET /api/data?table=clients
GET /api/data?table=tenders
```

### 3.3. Формат ответа

```json
{
  "columns": [
    { "key": "client_name", "label": "Клиент", "type": "string" },
    { "key": "amount", "label": "Сумма", "type": "number" },
    { "key": "date", "label": "Дата", "type": "date" }
  ],
  "rows": [
    {
      "client_name": "ООО Ромашка",
      "amount": 1500000,
      "date": "2024-01-15T00:00:00.000Z"
    }
  ]
}
```

Типы колонок (`type`) соответствуют ожидаемым типам в `DataTable.tsx`:

- `"string"`
- `"number"`
- `"date"`

### 3.4. Обработка ошибок

- При любом исключении внутри обработчика:
  - логируется ошибка на сервере;
  - клиенту возвращается `500` и JSON `{ "error": "Failed to fetch data" }`.

---

## 4. Связь фронтенда и API

- `ChatPanel`:
  - отправляет POST на `/api/chat` при отправке сообщения;
  - получает `reply` и `tableRequest`;
  - вызывает `onApplyRequest(tableRequest)`.
- `Dashboard`:
  - принимает `TableRequest` и, если поменялось поле `table`, запрашивает `/api/data?table=...`;
  - сохраняет полученные `columns`, `rows` и передаёт их в `DataTable`;
  - хранит `activeRequest` и прокидывает его в таблицу.
- `DataTable`:
  - использует `activeRequest` для применения фильтров/сортировки/видимости колонок.

Такое разделение позволяет в будущем:

- вынести `/api/data` на отдельный бэкенд;
- заменить YandexGPT на другой провайдер, сохранив формат `TableRequest`;
- добавить новые эндпоинты (например, для админки и загрузки Excel).

