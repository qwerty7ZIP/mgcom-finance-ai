# Архитектура MGCOM Finance AI

## 1. Общая схема

Проект представляет собой **full‑stack веб‑приложение** на базе **Next.js (App Router)**:

- **Фронтенд и серверная часть** живут в одном проекте `web`.
- **UI‑слой**: React‑компоненты (`Dashboard`, `DataTable`, `ChatPanel`, `ThemeToggle`).
- **Серверные роуты** (`/api/chat`, `/api/data`) реализуют:
  - взаимодействие с YandexGPT;
  - выдачу табличных данных из БД Supabase.
- **Слой данных** — таблицы `clients`, `contacts`, `tenders` в **Supabase (PostgreSQL)**, к которым обращаются серверные роуты.

Высокоуровневая схема:

1. Пользователь формулирует запрос в чате на русском языке.
2. Фронтенд отправляет запрос и историю диалога в `/api/chat`.
3. `/api/chat` обращается к YandexGPT, получает текст с JSON‑структурой запроса к данным.
4. API возвращает на фронтенд:
   - текст ответа (для показа в чате);
   - распарсенный JSON `tableRequest` (описание таблицы, фильтров, сортировки и т.д.).
5. `Dashboard`/`DataTable` применяют `tableRequest` к текущим данным, при необходимости запрашивая новую таблицу через `/api/data`.
6. Таблица отображается с фильтрами/сортировкой/пагинацией; пользователь может дальше уточнять запрос через чат.

## 2. Структура репозитория

Основные директории:

- `web/` — приложение Next.js (интерфейс и API).
- `documentation/` — документация проекта (вы читаете один из файлов здесь).
- `.gemini/` — служебные данные и скрипты для генерации дизайн‑системы (не участвуют в рантайме приложения).

Структура `web/src`:

- `app/`
  - `layout.tsx` — корневой layout приложения, шрифты и базовые стили.
  - `page.tsx` — главная страница, инициализация дашборда.
  - `api/`
    - `chat/route.ts` — API для общения с YandexGPT.
    - `data/route.ts` — API для получения табличных данных (демо).
- `components/`
  - `Dashboard.tsx` — композиция таблицы и чата, хранит состояние текущей таблицы и активного запроса.
  - `DataTable.tsx` — универсальный табличный компонент (фильтры/сортировка/пагинация/экспорт).
  - `ChatPanel.tsx` — UI‑панель чата с ИИ.
  - `ThemeToggle.tsx` — переключатель светлой/тёмной темы.
- `lib/`
  - `dbTable.ts` — загрузка табличных данных из Supabase.
  - `buildTableFromRecords.ts` — универсальный конструктор `{ columns, rows }` из массива записей.
  - `schemaDescription.ts` — паспорт схемы данных (описания таблиц и полей для ИИ).

## 3. Фронтенд‑слой

### 3.1. Главная страница (`page.tsx`)

- Серверный компонент `Home`:
  - вызывает `getDbTable("clients")` для загрузки стартовых колонок и строк из Supabase;
  - передаёт их в `Dashboard` как `initialColumns` и `initialRows`;
  - рендерит общий каркас приложения: верхний бар, переключатель темы, основную область.

### 3.2. Дашборд (`Dashboard.tsx`)

Основные ответственности:

- Хранит состояние:
  - `currentTable` — активная логическая таблица (`clients`, `contacts`, `tenders`);
  - `columns`, `rows` — текущие столбцы и строки;
  - `activeRequest` — последняя структура запроса от ИИ (`TableRequest`);
  - `loading` — флаг загрузки данных при смене таблицы.
- Обрабатывает применение запроса из чата:
  - при смене `req.table` запрашивает `/api/data?table=...`;
  - обновляет `columns`, `rows` и `currentTable`;
  - передаёт `activeRequest` в `DataTable` для применения фильтров/сортировки/видимости колонок.

### 3.3. Таблица (`DataTable.tsx`)

Функционал:

- Управление:
  - видимостью колонок (переключатели в дропдауне «Колонки»);
  - сортировкой по щелчку по заголовку;
  - фильтрами по каждой колонке (по типам: строка/число/дата);
  - пагинацией и размером страницы;
  - экспортом в CSV с учётом текущих фильтров и видимых колонок.
- Интеграция с ИИ‑запросом:
  - принимает `activeRequest` и:
    - настраивает видимые колонки по `columns` из `TableRequest`;
    - настраивает сортировку по `sort`;
    - выставляет начальные фильтры по `filters`.
  - Использует гибкое сопоставление полей (`findColumn`), чтобы выдерживать погрешности в именах колонок, которые вернёт модель.

Таблица полностью клиентская, оптимизирована под тысячи строк (фильтрация/сортировка/пагинация происходят в памяти на текущем наборе данных).

### 3.4. Чат (`ChatPanel.tsx`)

Ключевые обязанности (по коду и плану):

- UI чата с историей сообщений.
- Отправка сообщений и истории в `/api/chat`.
- При получении ответа:
  - отображает текст ИИ в ленте чата;
  - извлекает/принимает JSON `tableRequest` и передаёт его наверх через `onApplyRequest` в `Dashboard`.

## 4. Серверный слой (API)

### 4.1. `/api/data` (`app/api/data/route.ts`)

- Метод: `GET`.
- Параметр запроса: `table` — логическое имя таблицы (`clients` по умолчанию).
- Действия:
  - вызывает `getDemoTable(table)` из `lib/demoTable.ts`;
  - возвращает JSON `{ columns, rows }`;
  - логирует ошибку и отдаёт `500`, если что‑то пошло не так.

В будущем этот маршрут будет читать данные не из демо‑файла, а из слоя работы с Excel/БД, описанного в `PLAN.md` и `DATA_MODEL.md`.

### 4.2. `/api/chat` (`app/api/chat/route.ts`)

- Метод: `POST`.
- Принимает JSON‑тело `ChatBody`:
  - `message?: string` — последнее сообщение пользователя;
  - `history?: { role: "user" | "ai"; text: string }[]` — история диалога.
- Формирует список сообщений для YandexGPT:
  - `systemPrompt` с описанием задачи, схемы таблиц и формата ответа;
  - история диалога (перекодированная в роли `user`/`assistant`);
  - последнее сообщение пользователя (если передано).
- Конфигурация:
  - `YANDEX_GPT_API_KEY` — API‑ключ;
  - `YANDEX_GPT_FOLDER_ID` — ID папки;
  - `YANDEX_GPT_MODEL_URI` — явный URI модели (опционально, иначе собирается автоматически).
- Если конфиг не задан:
  - возвращает **заглушку** с текстом и тестовым `tableRequest` (таблица `clients`).
- При успешном ответе от YandexGPT:
  - извлекает текст ответа;
  - пытается вырезать JSON (поддерживает варианты с ```json```/``` и с текстом вокруг);
  - парсит JSON и отдаёт:
    - `reply` — полный текст ответа модели (для показа в чате);
    - `data` — распарсенный JSON для таблицы.

## 5. Данные и будущий слой Excel/БД

Сейчас данные живут в `lib/demoTable.ts` и представляют собой **искусственно сгенерированную таблицу** с набором колонок и строк.

План (см. `PLAN.md` и `DATA_MODEL.md`):

- Источники:
  - `data-files/NewBiz - Все тендеры.xlsx`
  - `data-files/клиенты-ai.xlsx`
  - `data-files/Контакты-ai.xlsx`
- Будет реализован слой:
  - чтения и парсинга этих файлов (например, через `xlsx`/`exceljs`);
  - сохранения структурированных данных в БД/кэше;
  - построения логических таблиц `clients`, `contacts`, `tenders` со связью по полю «Клиент»;
  - исполнения `tableRequest` в виде запросов к этим данным.

## 6. Конфигурация и окружение

Ключевые параметры окружения (переменные среды):

- `YANDEX_GPT_API_KEY` — секретный ключ доступа к YandexGPT.
- `YANDEX_GPT_FOLDER_ID` — идентификатор папки в Yandex Cloud.
- `YANDEX_GPT_MODEL_URI` — явный URI модели (опционально).

Переменные должны быть заданы в `.env.local` в папке `web` (файл не коммитится в репозиторий).

## 7. Нефункциональные требования

- **Производительность**:
  - Таблица рассчитана на тысячи строк (сортировка/фильтрация/пагинация на клиенте).
  - В будущем часть логики может быть вынесена на сервер для работы с большими объёмами.
- **Безопасность**:
  - Доступ к данным ограничен внутренней сетью компании (предполагается on‑prem/закрытое размещение).
  - ИИ‑ключи и доступы хранятся только в переменных окружения.
- **Расширяемость**:
  - Возможность добавления новых логических таблиц без переписывания фронтенда (таблица конфигурируется колонками и типами).
  - `tableRequest` спроектирован как расширяемая структура для фильтров, сортировок и агрегаций.

